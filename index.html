<!doctype html>
<meta charset="utf-8" />
<title>CPAx – COSMIN taxonomy (interactive circle packing)</title>
<style>
  :root{
    --bg: #d7ecf7;
    --node0: #ffffff;
    --node1: #cfe8f6;
    --node2: #a9d6ee;
    --node3: #7cc0e3;
    --text: #163a5f;
  }
  body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: var(--bg); color: var(--text); }
  header{ padding: 18px 22px 8px 22px; font-size: 22px; font-weight: 650; letter-spacing: .2px; }
  #wrap{ padding: 10px 18px 18px 18px; }
  svg{ width: 100%; height: 86vh; display:block; }
  .label{ pointer-events:none; text-anchor: middle; fill: var(--text); font-weight: 650; }
  .subtle{ font-weight: 500; opacity: .9; }
  .tooltip{
    position: fixed; pointer-events: none; background: rgba(255,255,255,.98);
    border: 1px solid rgba(0,0,0,.12); border-radius: 10px; padding: 10px 12px;
    box-shadow: 0 8px 22px rgba(0,0,0,.12); max-width: 420px; font-size: 13px; line-height: 1.25;
    opacity: 0; transform: translate(-10px, -10px);
  }
  .kpi{ display:flex; gap:10px; margin-top:6px; flex-wrap:wrap; }
  .pill{ border:1px solid rgba(0,0,0,.12); border-radius: 999px; padding: 2px 8px; font-size: 12px;
         background: rgba(215,236,247,.55); }
  .legend{ margin: 6px 0 0 0; font-size: 12px; opacity: .9; }
</style>

<header>Measurement Properties of Outcome Measurement Instruments (COSMIN) – CPAx review</header>
<div id="wrap">
  <div class="legend">Click to zoom. Hover to detail.</div>
  <svg id="chart" viewBox="0 0 960 720"></svg>
</div>
<div id="tt" class="tooltip"></div>

<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
<script>
(async function(){
  const data = await fetch("./cosmin_cpax_studies.json").then(r => r.json());

  const svg = d3.select("#chart");
  const width = 960, height = 720;
  const tt = d3.select("#tt");

  function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

  const fillByDepth = (d) => {
    if (d.depth === 0) return "transparent";
    if (d.depth === 1) return getCSS("--node0");
    if (d.depth === 2) return getCSS("--node1");
    if (d.depth === 3) return getCSS("--node2");
    return getCSS("--node3");
  };

  const root = d3.hierarchy(data)
    .sum(d => d.value || 0)
    .sort((a,b) => b.value - a.value);

  const pack = d3.pack().size([width, height]).padding(6);
  pack(root);

  let focus = root;
  let view;

  const g = svg.append("g");

  const nodes = g.selectAll("circle")
    .data(root.descendants().slice(1))
    .join("circle")
      .attr("fill", d => fillByDepth(d))
      .attr("stroke", d => d.children ? "rgba(22,58,95,.18)" : "rgba(22,58,95,.25)")
      .attr("stroke-width", d => d.children ? 1.2 : 2.0)
      .style("cursor", d => d.children ? "pointer" : "default")
      .on("mouseover", (event, d) => showTT(event, d))
      .on("mousemove", (event) => moveTT(event))
      .on("mouseout", hideTT)
      .on("click", (event, d) => { if (d.children) zoom(event, d); event.stopPropagation(); });

  const labels = g.append("g")
    .attr("pointer-events","none")
    .selectAll("text")
    .data(root.descendants())
    .join("text")
      .attr("class","label")
      .style("fill-opacity", d => d.parent === root ? 1 : 0)
      .style("display", d => d.parent === root ? "inline" : "none")
      .text(d => d.data.name);

  svg.on("click", (event) => zoom(event, root));

  zoomTo([root.x, root.y, root.r * 2]);

  function zoom(event, d){
    focus = d;
    const transition = svg.transition()
      .duration(650)
      .tween("zoom", () => {
        const i = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);
        return t => zoomTo(i(t));
      });

    labels
      .filter(function(n){ return n.parent === focus || this.style.display === "inline"; })
      .transition(transition)
        .style("fill-opacity", n => n.parent === focus ? 1 : 0)
        .on("start", function(n){ if (n.parent === focus) this.style.display = "inline"; })
        .on("end", function(n){ if (n.parent !== focus) this.style.display = "none"; });
  }

  function zoomTo(v){
    const k = width / v[2];
    view = v;
    g.attr("transform", `translate(${width/2},${height/2})`);
    nodes.attr("transform", d => `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`);
    nodes.attr("r", d => d.r * k);
    labels.attr("transform", d => `translate(${(d.x - v[0]) * k},${(d.y - v[1]) * k})`);
  }

  function showTT(event, d){
    const isLeaf = !d.children;
    const country = d.data.country ?? "";
    const design = d.data.study_design ?? "";
    const n = d.data.sample_size_n ?? "";

    tt.style("opacity", 1)
      .html(`
        <div style="font-weight:700; margin-bottom:4px;">${escapeHTML(d.data.name)}</div>
        <div class="subtle">${escapeHTML(getPath(d))}</div>
        ${isLeaf ? `
          <div class="kpi">
            ${country ? `<div class="pill">Country: ${escapeHTML(country)}</div>` : ``}
            ${design ? `<div class="pill">Design: ${escapeHTML(design)}</div>` : ``}
            ${n ? `<div class="pill">n: ${escapeHTML(n)}</div>` : ``}
          </div>
        ` : ``}
      `);
    moveTT(event);
  }

  function moveTT(event){
    tt.style("left", (event.clientX + 14) + "px").style("top", (event.clientY + 14) + "px");
  }

  function hideTT(){ tt.style("opacity", 0); }

  function getPath(d){
    return d.ancestors().reverse().map(x => x.data.name).slice(0,-1).join(" → ");
  }

  function escapeHTML(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }
})();
</script>
